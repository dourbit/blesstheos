#!/usr/bin/env bash

# Installs packages, expecting:
# $1 = filepath
# $@ = filepath(s) # TODO

path="$1"

# verify it's bash version >= 4
# for associative arrays, used next
if [ ${BASH_VERSION%%[^0-9]*} -lt 4 ]; then
  echo "Bash must be version 4 or greater."
  echo "Currently it's: '${BASH_VERSION}'."
  exit 1
fi

# special cases when command isn't the filename
# if a file isn't in this list, the $command is taken up until the first dash
declare -A special=(
  ["apt"]="apt-get"
  ["apt-get"]="apt-get" # just for example, or the '-get' would get truncated
  ["brew-cask"]="brew cask"
)

id=$(basename "$path")
pm=$(echo $id | sed s/-.*//) # package manager default
[[ ${special[$id]+_} ]] && pm=${special[$id]}

# TODO: verify $pm is installed, as well as...
# system-specific, if comand or filename match any of the following
declare -A syscheck=(
  ["apm-darwin"]="darwin"
  ["apt-get"]="linux" # could check for ubuntu or debian
  ["brew"]="darwin"
  ["brew cask"]="darwin"
)

# it's `$pm install $package` - except for the following special cases
declare -A install=(
  ["npm"]="npm i -g"
)

command="$pm install"
[[ ${install[$pm]+_} ]] && command=${install[$pm]}

echo "Installing $path packages with $pm:"
echo

sed -f $(dirname "$0")/ids.sed $@ | xargs -n 1 echo \$ $command
