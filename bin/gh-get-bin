#!/usr/bin/env bash

# `install/shell` for the JSONPath.sh

# Get a binary asset from GitHub, give it the following args:
# $1 user/repo
# $2 file-name
# $3 [tag-name] optional: defaults to "latest"
# $4 [dir-name] destination directory optional: defaults to the current dir .

# Require 2 args
if [[ $# -lt 2 ]]; then
    echo "Usage: $(basename $0) user/repo file-name [tag_name or latest] [save-to-dir or .]"
    exit 1
fi

REPOPATH=$1
FILENAME=$2
TAG_NAME=${3-"latest"}
SAVE_DIR=${4-$(pwd)}
GET_THIS="https://api.github.com/repos/${REPOPATH}/releases/${TAG_NAME}"
# https://developer.github.com/v3/repos/releases/#get-a-release-by-tag-name
DOWNLOAD=$(curl -sSL "${GET_THIS}" | JSONPath.sh '$.."browser_download_url"' | grep $FILENAME | awk '{print $NF}' | tr -d '"')

if [ ! "$DOWNLOAD" ]; then
  echo "Nothing for ${GET_THIS}"
else
  if curl-report ${DOWNLOAD} -H 'Accept:application/octet-stream' -o ~/tmp/${FILENAME}; then
    chmod +x ~/tmp/${FILENAME} && mkdir -p ${SAVE_DIR}
    mv ~/tmp/${FILENAME} ${SAVE_DIR}/${FILENAME}
    echo "Located:"
    echo "$(ls -l ${SAVE_DIR}/${FILENAME})"
  elif [ -f ~/tmp/${FILENAME} ]; then
    rm ~/tmp/${FILENAME}
  fi
fi
